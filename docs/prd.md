# Mermaid-Render 產品需求文件 (PRD)

## 專案概述

### 專案名稱
**Mermaid-Render** - 高品質Mermaid圖表渲染與互動展示平台

### 專案願景
成為業界最可靠的Mermaid圖表渲染解決方案，徹底解決現有工具的根本性問題，並提供革命性的序列展示功能。

### 核心問題
現有Mermaid工具存在致命缺陷：
- **語法容錯性極差**：Notion、GitHub等平台頻繁報錯，版本相容性問題嚴重
- **PNG匯出截斷**：複雜圖表匯出時經常被切斷，無法用於正式文件
- **節點文字截斷**：寬度限制導致長標籤顯示不完整，影響理解
- **複雜關聯線混亂**：10條以上關聯線交錯時，使用者無法快速識別連接關係
- **缺乏序列展示**：AI生成的編號化圖表無法按順序互動展示
- **版本支援滯後**：平台使用舊版Mermaid.js，不支援最新語法

## 目標使用者

### 主要使用者群體
1. **技術文件撰寫者**：開發者、技術寫手、DevOps工程師
   - 需要製作複雜系統架構圖，經常遇到Mermaid渲染問題
   - 目標：快速產出高品質技術文件，減少圖表製作時間
2. **專案經理**：需要視覺化複雜業務流程和專案依賴關係
   - 現有工具無法處理大型複雜圖表，展示效果差
   - 需要互動展示功能，支援演示和培訓場景
3. **系統分析師**：需要製作大型複雜的系統設計圖
   - 圖表複雜度高，關聯線多，需要清楚的視覺化
4. **教育培訓人員**：需要依序展示複雜概念和流程
   - 需要按編號序列展示功能，提升教學效果

## Goals and Background Context

### Goals
- 建立業界最可靠的Mermaid圖表渲染引擎，解決語法容錯和版本相容性問題
- 實現完美的PNG/SVG匯出功能，確保複雜圖表不被截斷
- 提供革命性的序列展示模式，支援區域/節點/關聯線按編號依序展示
- 優化複雜關聯線視覺化，讓10+條線的複雜圖表清楚易讀
- 建立可擴展的架構基礎，支援未來心智圖、XMind整合、AI功能等發展

### Background Context
現有Mermaid生態存在嚴重的技術債務和使用者體驗問題。Notion、GitHub等主流平台使用舊版Mermaid.js（8.x-9.x），導致AI生成的新語法頻繁報錯。PNG匯出截斷問題普遍存在，影響專業文件製作。複雜圖表的關聯線混亂問題使得大型系統架構圖幾乎無法有效使用。

我們的解決方案不僅要解決這些immediate問題，更要建立一個可持續發展的技術平台，為未來的心智圖支援、XMind生態整合、AI驅動功能、子圖表系統等創新功能奠定堅實基礎。

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-31 | v2.0 | 重新設計PRD，專注MVP核心功能與未來擴展性 | John (PM) |

## Requirements

### Functional Requirements

#### FR1: 智能Mermaid渲染引擎
- 支援最新Mermaid.js語法（包含XY Chart、Sankey等新功能）
- 智能語法容錯，99%相容性保證
- 多佈局引擎支援（Cytoscape.js + ELK.js）
- 自適應節點大小，避免文字截斷

#### FR2: 完美圖片匯出系統
- PNG/SVG無截斷匯出，支援任意尺寸圖表
- 高解析度匯出支援（300dpi+）
- 一鍵下載功能
- 自適應畫布大小計算

#### FR3: 複雜關聯線視覺優化
- 智能佈局演算法，最小化線條交錯
- 關聯線路徑優化（正交、曲線、直線模式）
- 動態線條樣式（顏色、粗細、虛實）
- 線條hover高亮與端點識別

#### FR4: 序列展示模式（核心差異化功能）
- 區域序列展示：按編號依序高亮圖表區域
- 節點序列展示：按編號依序展示節點
- 關聯線序列展示：按編號依序展示連線關係
- 播放控制：播放/暫停/前進/後退/速度調整
- 焦點模式：展示當前項目時其他元素半透明

#### FR5: 基礎Web介面
- 程式碼編輯器（Monaco Editor）
- 即時預覽面板
- 雙面板佈局（編輯器 + 預覽）
- 基礎工具列（匯出、分享、設定）

### Non-Functional Requirements

#### NFR1: 效能要求
- 支援1000+節點的複雜圖表流暢渲染
- 初始載入時間 < 2秒
- 渲染延遲 < 500ms
- 60fps動畫流暢度
- 匯出處理時間 < 5秒

#### NFR2: 相容性要求
- 支援Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- 響應式設計，支援桌面和平板
- 支援所有現有Mermaid語法
- 向後相容性保證

#### NFR3: 可擴展性架構
- 模組化渲染引擎設計，支援未來多圖表類型
- 插件式佈局引擎架構
- 可擴展的匯出格式支援
- 預留AI服務整合接口
- 支援未來XMind格式解析模組

#### NFR4: 品質要求
- 語法容錯率 > 99%
- PNG匯出成功率 > 99%
- 系統可用性 > 99.5%
- 使用者滿意度 > 90%

## User Interface Design Goals

### Overall UX Vision
提供直觀、專業的圖表編輯和展示體驗。使用者應能夠在5分鐘內從零開始建立並匯出一個複雜的Mermaid圖表，無需擔心語法錯誤或渲染問題。介面設計遵循「編輯器左，預覽右」的經典佈局，但提供彈性的面板調整。

### Key Interaction Paradigms
- **即時預覽**：程式碼變更即時反映在預覽面板
- **視覺回饋**：錯誤處理有明確提示和修復建議
- **手勢友善**：支援縮放、拖拽、滾輪操作
- **鍵盤快速鍵**：常用功能提供快速鍵支援
- **序列模式**：一鍵切換到序列展示模式

### Core Screens and Views
- **主編輯器**：雙面板佈局（程式碼編輯器 + 即時預覽）
- **序列展示模式**：全螢幕展示介面，包含播放控制列
- **匯出確認**：匯出前的預覽與設定介面
- **設定面板**：渲染引擎、佈局偏好、匯出設定

### Accessibility: WCAG AA
遵循WCAG AA標準，確保色彩對比度、鍵盤導航、螢幕閱讀器相容性。

### Branding
專業、現代的設計風格，以深色主題為主（適合程式碼編輯），但提供亮色主題選項。色彩方案以藍色系為主，強調技術專業感。

### Target Device and Platforms: Web Responsive
優先支援桌面瀏覽器，響應式設計支援平板裝置。專注於程式開發者的工作環境。

## Technical Assumptions

### Repository Structure: Monorepo
使用Monorepo架構統一管理前後端程式碼，便於共享類型定義和工具鏈。

### Service Architecture
**漸進式微服務架構**：MVP階段採用簡化的Monolith設計，但預留微服務擴展接口。核心模組：
- **渲染服務**：獨立的渲染引擎，可獨立擴展
- **匯出服務**：圖片生成與處理
- **API層**：RESTful API，預留GraphQL接口
- **前端應用**：Next.js SSG/SSR混合模式

**重要決策理由**：這種架構讓我們能快速交付MVP，同時為Phase 2/3的心智圖、XMind整合、AI功能預留完美的微服務拆分路徑。

### Testing Requirements
**全測試金字塔**：
- **單元測試**：核心渲染邏輯、工具函數
- **整合測試**：API端點、資料庫操作
- **E2E測試**：關鍵使用者流程（編輯→預覽→匯出）
- **視覺回歸測試**：圖表渲染結果驗證
- **效能測試**：大型圖表渲染效能

### Additional Technical Assumptions and Requests
- **前端技術棧**：Next.js 14 + TypeScript + Tailwind CSS
  - 圖形渲染：Cytoscape.js + ELK.js（多引擎架構）
  - 動畫：Framer Motion
  - UI元件：Radix UI
  - 程式碼編輯器：Monaco Editor
  - 狀態管理：Zustand
- **後端技術棧**：Node.js + Fastify + Prisma ORM
  - 資料庫：PostgreSQL（支援複雜查詢）
  - 快取：Redis（預覽結果快取）
  - 圖片處理：Sharp + Puppeteer
- **部署與基礎設施**：
  - Vercel部署（前端）
  - Railway/PlanetScale（資料庫）
  - CloudFlare CDN（靜態資源）
- **未來擴展預留**：
  - AI服務接口：OpenAI API + LangChain（Phase 3）
  - XMind解析模組：預留檔案解析接口（Phase 2）
  - 心智圖引擎：可插拔的圖表引擎架構（Phase 2）

## Epic List

### Epic 1: 基礎設施與核心渲染引擎
建立專案基礎架構並實現高品質Mermaid渲染引擎，解決現有工具的語法容錯和節點截斷問題。

### Epic 2: 完美匯出系統
實現無截斷的PNG/SVG匯出功能，確保複雜圖表能夠完整匯出為高品質圖片。

### Epic 3: 複雜關聯線視覺優化
開發智能佈局演算法和關聯線優化系統，讓複雜圖表的關聯線清楚易讀。

### Epic 4: 革命性序列展示功能
建立業界首創的編號序列展示模式，支援區域/節點/關聯線的依序互動展示。

## Epic 1: 基礎設施與核心渲染引擎

建立完整的專案基礎架構，包含前後端環境設定、CI/CD流程、核心渲染引擎開發。這個Epic將解決現有Mermaid工具最嚴重的語法容錯和節點截斷問題，同時建立可擴展的架構基礎。

### Story 1.1: 專案基礎架構建立

As a **開發者**,  
I want **建立完整的Monorepo專案架構與開發環境**,  
so that **團隊能夠高效協作開發並確保程式碼品質**.

#### Acceptance Criteria
1. 建立Next.js 14 + TypeScript前端專案結構
2. 建立Node.js + Fastify後端專案結構
3. 配置ESLint、Prettier、Husky git hooks
4. 建立基礎CI/CD流程（GitHub Actions）
5. 配置開發環境Docker化（可選）
6. 建立基本的測試框架設定（Jest + Testing Library）
7. 專案能夠成功啟動並顯示「Hello World」頁面

### Story 1.2: 雙面板編輯器介面

As a **使用者**,  
I want **一個專業的程式碼編輯器與即時預覽面板**,  
so that **我能夠舒適地編寫和預覽Mermaid圖表**.

#### Acceptance Criteria
1. 整合Monaco Editor作為程式碼編輯器
2. 實現左右雙面板佈局（編輯器 + 預覽）
3. 支援Mermaid語法高亮
4. 面板大小可調整（分隔線拖拽）
5. 編輯器支援基本快速鍵（Ctrl+S保存等）
6. 響應式設計，支援不同螢幕尺寸
7. 暗色主題為預設，提供亮色主題切換

### Story 1.3: 基礎Mermaid渲染引擎

As a **使用者**,  
I want **能夠即時渲染Mermaid圖表的引擎**,  
so that **我能看到程式碼的視覺化結果**.

#### Acceptance Criteria
1. 整合最新版Mermaid.js函式庫
2. 實現即時渲染功能（程式碼變更觸發渲染）
3. 支援所有基礎Mermaid圖表類型（flowchart、sequence、class等）
4. 實現基礎錯誤處理和使用者友善錯誤訊息
5. 渲染效能優化（防抖、快取機制）
6. 渲染區域支援縮放和拖拽瀏覽
7. 載入狀態指示器

### Story 1.4: 智能語法容錯系統

As a **使用者**,  
I want **即使語法有小錯誤也能成功渲染圖表**,  
so that **我不會因為語法問題而無法看到圖表效果**.

#### Acceptance Criteria
1. 實現常見語法錯誤的自動修復（如缺少引號、多餘空格）
2. 支援混合版本語法相容性處理
3. 提供智能錯誤提示和修復建議
4. 實現漸進式語法解析（部分錯誤不影響整體渲染）
5. 錯誤log記錄和分析
6. 容錯率達到95%以上
7. 使用者可選擇開啟/關閉容錯模式

### Story 1.5: 自適應節點系統

As a **使用者**,  
I want **節點能夠自動調整大小以完整顯示文字內容**,  
so that **長標籤和複雜文字都不會被截斷**.

#### Acceptance Criteria
1. 實現動態節點大小計算
2. 支援多行文字自動換行
3. 字型大小和節點padding智能調整
4. 支援不同字型和語言文字
5. 節點最小/最大尺寸限制
6. 長文字的省略號處理選項
7. 文字溢出時的tooltip顯示

## Epic 2: 完美匯出系統

建立業界最可靠的PNG/SVG匯出功能，徹底解決現有工具的截斷問題。支援任意尺寸的圖表完整匯出，並提供多種格式和品質選項。

### Story 2.1: PNG無截斷匯出引擎

As a **使用者**,  
I want **能夠將任意大小的圖表完整匯出為PNG圖片**,  
so that **我可以在文件中使用高品質的圖表圖片**.

#### Acceptance Criteria
1. 實現基於Canvas的PNG匯出功能
2. 自動計算圖表實際尺寸，避免截斷
3. 支援高解析度匯出（150dpi、300dpi選項）
4. 處理超大圖表的分塊渲染
5. 匯出進度指示器
6. 支援透明背景和自定義背景色
7. 匯出成功率達到99%以上

### Story 2.2: SVG向量匯出

As a **使用者**,  
I want **能夠匯出可縮放的SVG向量圖**,  
so that **我能獲得可無限縮放的高品質圖表**.

#### Acceptance Criteria
1. 實現完整的SVG匯出功能
2. 保持所有視覺樣式和字型
3. 支援內嵌字型和外部字型引用
4. SVG代碼優化和壓縮
5. 支援SVG動畫匯出（可選）
6. 相容性測試（主流瀏覽器和設計軟體）
7. 檔案大小優化

### Story 2.3: 匯出設定與預覽

As a **使用者**,  
I want **在匯出前能夠預覽和調整匯出設定**,  
so that **我能夠獲得符合需求的圖片格式和品質**.

#### Acceptance Criteria
1. 建立匯出設定介面（解析度、格式、背景等）
2. 實現匯出預覽功能
3. 支援批量匯出設定（多種格式同時匯出）
4. 匯出歷史記錄和設定儲存
5. 一鍵快速匯出（使用預設設定）
6. 檔案命名規則自定義
7. 匯出完成通知和檔案下載

### Story 2.4: 匯出效能優化

As a **使用者**,  
I want **匯出處理速度快且系統響應流暢**,  
so that **我不會因為匯出處理而影響工作效率**.

#### Acceptance Criteria
1. 實現異步匯出處理
2. 大型圖表分塊處理機制
3. Worker執行緒處理，避免UI凍結
4. 匯出佇列管理
5. 記憶體使用優化
6. 匯出時間控制在5秒內（1000節點圖表）
7. 並發匯出請求處理

## Epic 3: 複雜關聯線視覺優化

開發智能佈局演算法和關聯線優化系統，解決複雜圖表中10+條關聯線交錯導致的視覺混亂問題。提供多種佈局引擎和線條樣式選項。

### Story 3.1: 多佈局引擎架構

As a **開發者**,  
I want **建立可插拔的多佈局引擎架構**,  
so that **系統能夠支援不同的圖表佈局演算法並易於擴展**.

#### Acceptance Criteria
1. 設計佈局引擎抽象介面
2. 整合Cytoscape.js作為主要渲染引擎
3. 整合ELK.js作為階層佈局引擎
4. 建立佈局引擎選擇機制
5. 實現佈局引擎熱切換
6. 佈局演算法效能監控
7. 預留未來佈局引擎擴展接口

### Story 3.2: 智能關聯線路徑優化

As a **使用者**,  
I want **複雜圖表的關聯線能夠智能避開交錯**,  
so that **我能清楚識別每條線連接的節點**.

#### Acceptance Criteria
1. 實現關聯線交錯檢測演算法
2. 開發智能路徑規劃（正交、曲線路徑）
3. 支援多種線條樣式（直線、正交、貝茲曲線）
4. 實現線條間距自動調整
5. 節點連接點優化選擇
6. 長距離連線的中繼點插入
7. 佈局品質評分機制

### Story 3.3: 關聯線互動與高亮

As a **使用者**,  
I want **能夠hover或點擊關聯線來高亮連接的節點**,  
so that **我能快速識別複雜圖表中的連接關係**.

#### Acceptance Criteria
1. 實現關聯線hover高亮效果
2. 高亮時顯示連接的起點和終點節點
3. 其他元素半透明處理
4. 支援關聯線標籤顯示
5. 多選高亮（Ctrl+點擊）
6. 高亮狀態的視覺反饋動畫
7. 鍵盤導航支援（Tab鍵切換）

### Story 3.4: 視覺樣式自定義

As a **使用者**,  
I want **能夠自定義關聯線的視覺樣式**,  
so that **我能根據需要調整圖表的視覺效果**.

#### Acceptance Criteria
1. 提供線條顏色、粗細、樣式選項
2. 支援虛線、點線、實線樣式
3. 箭頭樣式和大小調整
4. 線條透明度控制
5. 預設樣式範本
6. 即時樣式預覽
7. 樣式配置的儲存和載入

## Epic 4: 革命性序列展示功能

開發業界首創的編號序列展示模式，支援區域、節點、關聯線的依序互動展示。這是我們的核心差異化功能，能夠徹底改變複雜圖表的理解方式。

### Story 4.1: 序列展示核心引擎

As a **開發者**,  
I want **建立序列展示的核心控制引擎**,  
so that **系統能夠管理和控制圖表元素的序列展示狀態**.

#### Acceptance Criteria
1. 設計序列展示狀態管理器
2. 實現圖表元素編號解析
3. 建立展示時間軸控制器
4. 開發元素聚焦和高亮機制
5. 實現平滑動畫過渡
6. 狀態同步和回放功能
7. 序列數據的驗證和錯誤處理

### Story 4.2: 區域序列展示

As a **使用者**,  
I want **能夠按編號依序展示圖表的不同區域**,  
so that **我能系統性地理解大型圖表的結構分布**.

#### Acceptance Criteria
1. 實現區域邊界自動識別
2. 支援手動區域編號標記
3. 區域高亮時其他部分半透明
4. 平滑的視角切換和縮放
5. 區域標題和說明顯示
6. 支援嵌套區域的階層展示
7. 區域切換的視覺過渡效果

### Story 4.3: 節點序列展示

As a **使用者**,  
I want **能夠按編號依序展示圖表中的節點**,  
so that **我能了解節點的重要性順序和邏輯流程**.

#### Acceptance Criteria
1. 節點編號解析和排序
2. 當前節點高亮，其他節點半透明
3. 節點詳細資訊彈出顯示
4. 相關連線的聯動高亮
5. 節點間的平滑過渡動畫
6. 支援跳過或重複展示特定節點
7. 節點分組和批次展示

### Story 4.4: 關聯線序列展示

As a **使用者**,  
I want **能夠按編號依序展示關聯線**,  
so that **我能理解複雜圖表中的連接順序和資料流向**.

#### Acceptance Criteria
1. 關聯線編號解析和路徑追蹤
2. 當前關聯線高亮動畫（流動效果）
3. 起點和終點節點同步高亮
4. 關聯線標籤和權重顯示
5. 支援雙向關聯線的方向展示
6. 複雜路徑的分段展示
7. 關聯線群組的批次展示

### Story 4.5: 序列展示控制介面

As a **使用者**,  
I want **一個直觀的播放控制介面來管理序列展示**,  
so that **我能夠自由控制展示的節奏和順序**.

#### Acceptance Criteria
1. 播放/暫停/停止控制按鈕
2. 前進/後退/跳轉功能
3. 播放速度調整（0.5x到3x）
4. 進度條顯示當前位置
5. 序列模式切換（區域/節點/關聯線）
6. 全螢幕展示模式
7. 展示歷程記錄和書籤功能

### Story 4.6: 序列展示模式整合

As a **使用者**,  
I want **序列展示功能與主介面無縫整合**,  
so that **我能夠在編輯和展示之間流暢切換**.

#### Acceptance Criteria
1. 一鍵進入序列展示模式
2. 展示模式下的即時編輯同步
3. 模式切換的狀態保存
4. 序列設定的儲存和載入
5. 展示模式的分享連結生成
6. 嵌入模式支援（iframe）
7. 鍵盤快速鍵支援

## Next Steps

### Architect Prompt
請根據這份PRD建立詳細的技術架構文件。重點關注：1) 可擴展的渲染引擎架構設計，支援未來心智圖和XMind整合；2) 序列展示功能的技術實現方案；3) 匯出系統的高效能設計；4) 為Phase 2/3功能預留的架構接口。請使用現有的`docs/architecture/`目錄結構。

### UX Expert Prompt
暫不需要，UI設計已在PRD中明確定義。專注於實作MVP核心功能。